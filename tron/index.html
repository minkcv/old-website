<!DOCTYPE html>
<html>
<style>
body {
    font-family: arial, sans-serif;
    background-color: #b8b8b8;
    margin: 0px;
}
#header {
    background-color: #282828;
    color: #e8e8e8;
    padding: 10px;
    margin-bottom: 5px;
}
#instructions {
    float: left;
    padding-right: 10px;
    margin-left: 10px;
}
#game {
    float: left;
    border: thick;
    border-color: #b8b8b8;
    width: 600px;
    height: 600px;
    padding-top: 0px;
    padding-bottom: 0px;
    margin-left: 10px;
}
</style>
<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
<script>
$(function(){
    var playernumber = 0;
    var player1name;
    var player2name;
    var gamestate = 0;
	var socket = io('zcraft.no-ip.org:3001');
	var c = document.getElementById("gamecanvas");
	var ctx = c.getContext("2d");
    var fps = 30;
	var x1;
	var y1;
	var x2;
	var y2;
    var direction;
	var blocksize = 10;
	var canvasWidth = c.getAttribute("width");
	var canvasHeight = c.getAttribute("height");
	var keysDown = {};
    var blocks;

    var sanitizeString = function(str){
        str = str.replace(/[^a-z0-9áéíóúñü \.,_-]/gim,"");
        return str.trim();
    }

	$('form').submit(function(){
        if(gamestate != 1 && playernumber == 0){
            var username = sanitizeString($('#username').val());
            socket.emit('join', username);
            gamestate = 0
            init();
        }else{
            alert("you already picked a username, refresh to play again");
        }
		return false;
	});
  
    socket.on('game data', function(servergamedata){
        x1 = servergamedata.x1;
        y1 = servergamedata.y1;
        x2 = servergamedata.x2;
        y2 = servergamedata.y2;
        blocks = servergamedata.blocks;
    });
    socket.on('join response', function(joinresponse){
        console.log(joinresponse);
        if(joinresponse == "welcome player 1"){
            playernumber = 1;
            document.getElementById('gamestate').innerHTML = "Waiting for player 2";
            //init();
        }else if(joinresponse == "welcome player 2"){
            playernumber = 2;
            //init();
        }else if(joinresponse== "no available games"){
            playernumber = 3;
        }else if(joinresponse == "username already taken"){
            alert("username already taken");
        }
    });
    socket.on('player info', function(playerdata){
        player1name = playerdata.p1;
        player2name = playerdata.p2;
    });
    socket.on('game state', function(serverstate){
        console.log("game state from server: " + serverstate);
        gamestate = serverstate;
        if(gamestate == 1){
            if(playernumber == 1){
                document.getElementById('gamestate').innerHTML = player1name + " vs " + player2name + ". You are Red";
                document.getElementById('game').style.border = "thick solid #FF0000";
            }else{
                document.getElementById('gamestate').innerHTML = player1name + " vs " + player2name + ". You are Blue";
                document.getElementById('game').style.border = "thick solid #0000FF";
            }
        }
    });

    socket.on('winner', function(winner){
        if(winner != 'tie')
            document.getElementById('result').innerHTML = winner + " Wins!";
        else
            document.getElementById('result').innerHTML = "Its a tie.";
    });


	addEventListener("keydown", function(e) {
        keysDown[e.keyCode] = true;
        if(gamestate == 1){
            if (38 in keysDown && direction != 2) {
                direction = 0;
                socket.emit('direction', direction);
            }
            if (39 in keysDown && direction != 3) {
                direction = 1;
                socket.emit('direction', direction);
            }
            if (40 in keysDown && direction != 0) {
                direction = 2;
                socket.emit('direction', direction);
            }
            if (37 in keysDown && direction != 1) {
                direction = 3;
                socket.emit('direction', direction);
            }
        }
        keysDown = {};
	}, false);

	addEventListener("keyup", function(e) {
	  //delete keysDown[e.keyCode];
	}, false);

	var init = function() {
        if(playernumber == 1)
            direction = 2;
        else if(playernumber == 2)
            direction = 0;

        ctx.fillStyle = "#000000";
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
	}

	var render = function() {
        ctx.fillStyle = "#FF0000";
        ctx.fillRect(x1 * blocksize, y1 * blocksize, blocksize, blocksize);
        ctx.fillStyle = "#0000FF";
        ctx.fillRect(x2 * blocksize, y2 * blocksize, blocksize, blocksize);
        if(blocks && blocks.length){
            for(var i = 0; i < blocks.length; i++){
                for(var j = 0; j < blocks[i].length; j++){
                    if(blocks[i][j] == 1)
                        ctx.fillStyle = "#FF0000";
                    else if(blocks[i][j] == 2)
                        ctx.fillStyle = "#0000FF";

                    if(blocks[i][j] > 0)
                        ctx.fillRect(i * blocksize, j * blocksize, blocksize, blocksize);
                }
            }
        }
	}

	var main = function() {
        var now = Date.now();
        var delta = now - then;
        if(gamestate != 0){
            render();
        }
        then = now;
        requestAnimationFrame(main);
	}

	var then = Date.now();
    main();
});
</script>
<body>
<div id='header'>
<h1>Multi-Tron</h1>
<p>A multiplayer tron clone in javascript</p>
</div>
<div id='instructions'>
<h2>Pick a Username</h2>
<form action="">
<input id="username" autocomplete="off" /><button>Send</button>
</form>
<h2>Game Info:</h2>
<div id="gamestate"></div>
<h2>Game Result:</h2>
<div id="result"></div>
</div>
<div id='game'>
<canvas id="gamecanvas" width="600" height="600"></canvas>
</div>
</body>
</html>
